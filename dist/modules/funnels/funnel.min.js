class FunnelAnalyzer{constructor(e={}){this.config={funnels:[],autoTrack:!0,...e},this.events=[],this.funnelData=new Map,this.config.autoTrack&&this.setupAutoTracking()}defineFunnel(e,t,s={}){const n={id:e,name:s.name||e,steps:t.map(((e,t)=>({id:e.id||`step_${t}`,name:e.name,url:e.url,event:e.event,selector:e.selector,order:t}))),options:{timeWindow:s.timeWindow||36e5,allowBacktrack:s.allowBacktrack||!1,...s}};return this.config.funnels.push(n),this.funnelData.set(e,{funnel:n,sessions:new Map,stats:this.initializeFunnelStats(n.steps.length)}),n}initializeFunnelStats(e){const t={totalSessions:0,completedSessions:0,conversionRate:0,steps:[]};for(let s=0;s<e;s++)t.steps.push({stepIndex:s,reached:0,dropped:0,conversionFromPrevious:0,averageTimeToNext:0,commonDropoffReasons:[]});return t}setupAutoTracking(){this.trackPageView=(e,t)=>{this.addEvent({type:"pageview",url:e||window.location.href,title:t||document.title,timestamp:Date.now()})},document.addEventListener("click",(e=>{this.addEvent({type:"click",element:this.getElementInfo(e.target),timestamp:Date.now(),url:window.location.href})})),document.addEventListener("submit",(e=>{this.addEvent({type:"form_submit",form:this.getFormInfo(e.target),timestamp:Date.now(),url:window.location.href})})),window.addEventListener("standlog_custom_event",(e=>{this.addEvent({type:"custom",name:e.detail.name,properties:e.detail.properties,timestamp:Date.now(),url:window.location.href})}))}addEvent(e){e.sessionId=this.getSessionId(),e.userId=this.getUserId(),this.events.push(e),this.analyzeEvent(e)}analyzeEvent(e){this.config.funnels.forEach((t=>{this.checkFunnelStep(t,e)}))}checkFunnelStep(e,t){const s=this.funnelData.get(e.id),n=t.sessionId;s.sessions.has(n)||s.sessions.set(n,{sessionId:n,userId:t.userId,startTime:t.timestamp,currentStep:-1,completedSteps:[],events:[],status:"active"});const o=s.sessions.get(n);o.events.push(t),e.steps.forEach(((s,n)=>{this.eventMatchesStep(t,s)&&this.processStepCompletion(e,o,n,t)}))}eventMatchesStep(e,t){if(t.url&&"pageview"===e.type&&e.url)return this.urlMatches(e.url,t.url);if(t.event){if("custom"===e.type&&e.name===t.event)return!0;if(e.type===t.event)return!0}return!(!t.selector||"click"!==e.type)&&this.elementMatchesSelector(e.element,t.selector)}processStepCompletion(e,t,s,n){const o=t.currentStep+1;s===o?(t.currentStep=s,t.completedSteps.push({stepIndex:s,timestamp:n.timestamp,event:n}),this.updateFunnelStats(e.id,t,s),s===e.steps.length-1&&(t.status="completed",this.onFunnelComplete(e,t))):e.options.allowBacktrack&&s<o&&(t.currentStep=s,this.onStepBacktrack(e,t,s))}updateFunnelStats(e,t,s){const n=this.funnelData.get(e),o=n.stats;if(o.steps[s].reached++,s>0){const e=o.steps[s-1];o.steps[s].conversionFromPrevious=o.steps[s].reached/e.reached*100}0===s&&o.totalSessions++,s===n.funnel.steps.length-1&&(o.completedSessions++,o.conversionRate=o.completedSessions/o.totalSessions*100)}onFunnelComplete(e,t){console.log(`Funnel ${e.name} completed by session ${t.sessionId}`);const s=t.events[t.events.length-1].timestamp-t.startTime,n=new CustomEvent("standlog_funnel_complete",{detail:{funnelId:e.id,sessionId:t.sessionId,completionTime:s,steps:t.completedSteps}});window.dispatchEvent(n)}onStepBacktrack(e,t,s){console.log(`Step backtrack in funnel ${e.name}: step ${s}`)}getFunnelAnalysis(e){const t=this.funnelData.get(e);if(!t)return null;return{funnel:t.funnel,stats:t.stats,sessions:Array.from(t.sessions.values()),dropoffAnalysis:this.analyzeDropoffs(t),timeAnalysis:this.analyzeTimings(t)}}analyzeDropoffs(e){const t=[],s=e.stats;for(let n=0;n<s.steps.length-1;n++){const o=s.steps[n],a=s.steps[n+1],i=o.reached-a.reached,r=i/o.reached*100;t.push({fromStep:n,toStep:n+1,dropoffCount:i,dropoffRate:r,insights:this.generateDropoffInsights(e,n)})}return t}analyzeTimings(e){const t=[];return Array.from(e.sessions.values()).forEach((e=>{for(let s=0;s<e.completedSteps.length-1;s++){const n=e.completedSteps[s],o=e.completedSteps[s+1].timestamp-n.timestamp;t.push({sessionId:e.sessionId,fromStep:s,toStep:s+1,duration:o})}})),this.aggregateTimings(t)}aggregateTimings(e){const t={};return e.forEach((e=>{const s=`${e.fromStep}_${e.toStep}`;t[s]||(t[s]={fromStep:e.fromStep,toStep:e.toStep,durations:[]}),t[s].durations.push(e.duration)})),Object.values(t).forEach((e=>{e.durations.sort(((e,t)=>e-t)),e.average=e.durations.reduce(((e,t)=>e+t),0)/e.durations.length,e.median=e.durations[Math.floor(e.durations.length/2)],e.min=e.durations[0],e.max=e.durations[e.durations.length-1]})),Object.values(t)}generateDropoffInsights(e,t){return["High dropoff rate detected","Consider simplifying this step","Average time spent: 2.3 minutes"]}urlMatches(e,t){if(t.includes("*")){const s=t.replace(/\*/g,".*");return new RegExp(s).test(e)}return e.includes(t)}elementMatchesSelector(e,t){try{return e.id===t.replace("#","")||e.className.includes(t.replace(".",""))||e.tagName.toLowerCase()===t.toLowerCase()}catch(e){return!1}}getElementInfo(e){return{tagName:e.tagName.toLowerCase(),id:e.id,className:e.className,textContent:e.textContent?.trim().substring(0,50)}}getFormInfo(e){return{id:e.id,action:e.action,method:e.method,fieldCount:e.elements.length}}getSessionId(){return localStorage.getItem("standlog_session")||"anonymous"}getUserId(){return localStorage.getItem("standlog_user")||"anonymous"}exportFunnelData(e,t="json"){const s=this.getFunnelAnalysis(e);return"csv"===t?this.convertToCSV(s):JSON.stringify(s,null,2)}convertToCSV(e){const t=[["Step","Reached","Conversion Rate","Avg Time"].join(",")];return e.stats.steps.forEach(((e,s)=>{t.push([`Step ${s+1}`,e.reached,`${e.conversionFromPrevious}%`,`${e.averageTimeToNext}ms`].join(","))})),t.join("\n")}}"undefined"!=typeof module&&module.exports?module.exports=FunnelAnalyzer:window.FunnelAnalyzer=FunnelAnalyzer;