const analytics=window._analytics?_analytics.init({app:"standlog"}):null,ANALYTICS_API_URL="";class StandLogAnalytics{key;constructor(e,t={}){this.key=e,this.config={enableHeatmaps:!0,enableFunnels:!0,enablePersonas:!0,enableDashboard:!0,enableIntegrations:!0,debug:!1,...t},this.sessionData=null,this.events=[],this.modules={},this.sessionCreated=!1,this.init()}async init(){this.sessionData={sessionId:this.generateSessionId(),userId:this.getUserId(),anonymousId:this.getAnonymousId(),startTime:Date.now(),pageViews:0,clicks:0,scrolls:0},this.setupTracking(),this.initializeModules()}setupTracking(){let e;this.trackPageView(),document.addEventListener("click",(e=>this.trackClick(e)),!0),window.addEventListener("scroll",(()=>{clearTimeout(e),e=setTimeout((()=>this.trackScroll()),100)}),{passive:!0}),document.addEventListener("submit",(e=>this.trackFormSubmit(e)),!0),window.addEventListener("beforeunload",(()=>this.sendEvents(!0)))}initializeModules(){this.config.enableHeatmaps&&this.initHeatmaps(),this.config.enableFunnels&&this.initFunnels(),this.config.enablePersonas&&this.initPersonas(),this.config.enableDashboard&&this.initDashboard(),this.config.enableIntegrations&&this.initIntegrations()}trackClick(e){const t={type:"click",timestamp:Date.now(),coordinates:{x:e.clientX,y:e.clientY,pageX:e.pageX,pageY:e.pageY},element:this.getElementInfo(e.target),url:window.location.href,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId};this.addEvent(t),this.sessionData.clicks++}trackScroll(){const e={type:"scroll",timestamp:Date.now(),scroll:{x:window.scrollX,y:window.scrollY,percentage:window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100},url:window.location.href,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId};this.addEvent(e),this.sessionData.scrolls++}trackPageView(){const e={type:"pageview",timestamp:Date.now(),url:window.location.href,title:document.title,referrer:document.referrer,device:this.getDeviceInfo(),sessionId:this.sessionData.sessionId,userId:this.sessionData.userId};this.addEvent(e),this.sessionData.pageViews++}trackFormSubmit(e){const t={type:"form_submit",timestamp:Date.now(),form:{id:e.target.id,action:e.target.action,method:e.target.method},url:window.location.href,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId};this.addEvent(t)}initHeatmaps(){this.modules.heatmaps={clickData:[],scrollData:[],createHeatmap:(e,t="click")=>this.createHeatmap(e,t)}}createHeatmap(e,t){const s=document.getElementById(e);if(!s)return null;const n=this.events.filter((e=>e.type===t));return this.renderHeatmap(s,n,t)}renderHeatmap(e,t,s){const n=document.createElement("canvas");n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.zIndex="1000",n.style.pointerEvents="auto";const a=n.getContext("2d");e.appendChild(n);let i=1;const r=()=>{n.width=e.offsetWidth,n.height=e.offsetHeight,a.clearRect(0,0,n.width,n.height),a.save(),a.translate(0,0),a.scale(i,i),t.forEach((e=>{"click"===s&&e.coordinates&&(a.fillStyle="rgba(255, 0, 0, 0.6)",a.beginPath(),a.arc(e.coordinates.pageX,e.coordinates.pageY,10,0,2*Math.PI),a.fill())})),a.restore()};return n.addEventListener("wheel",(e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;i=Math.max(.1,Math.min(5,i*t)),r()})),r(),{canvas:n,render:r,destroy:()=>e.removeChild(n)}}initFunnels(){this.modules.funnels={funnels:new Map,defineFunnel:(e,t,s={})=>this.defineFunnel(e,t,s),trackStep:(e,t)=>this.trackFunnelStep(e,t)}}defineFunnel(e,t,s){const n={id:e,name:s.name||e,steps:t.map(((e,t)=>({id:e.id||`step_${t}`,name:e.name,url:e.url,event:e.event,order:t}))),analytics:{totalUsers:0,completions:0,dropoffs:t.map((()=>({reached:0,dropped:0})))}};return this.modules.funnels.funnels.set(e,n),n}trackFunnelStep(e,t){const s=this.modules.funnels?.funnels.get(e);if(!s)return;const n=s.steps.find((e=>e.id===t));n&&(s.analytics.dropoffs[n.order].reached++,n.order===s.steps.length-1&&s.analytics.completions++)}initPersonas(){this.modules.personas={personas:new Map,userProfiles:new Map,definePersona:(e,t)=>this.definePersona(e,t),analyzeUser:e=>this.analyzeUserPersona(e)},this.definePersona("power_user",{name:"Power User",rules:[{metric:"pageViews",operator:">",value:10}]}),this.definePersona("bouncer",{name:"Bouncer",rules:[{metric:"sessionDuration",operator:"<",value:3e4}]})}definePersona(e,t){this.modules.personas.personas.set(e,{id:e,name:t.name,rules:t.rules,users:new Set})}analyzeUserPersona(e){const t=this.getUserProfile(e),s=[];return this.modules.personas.personas.forEach(((n,a)=>{this.userMatchesPersona(t,n)&&(s.push(a),n.users.add(e))})),s}userMatchesPersona(e,t){return t.rules.every((t=>{const s=this.getUserMetricValue(e,t.metric);switch(t.operator){case">":return s>t.value;case"<":return s<t.value;case">=":return s>=t.value;case"<=":return s<=t.value;case"=":return s===t.value;default:return!1}}))}getUserProfile(e){return{userId:e,pageViews:this.sessionData.pageViews,sessionDuration:Date.now()-this.sessionData.startTime,clicks:this.sessionData.clicks}}getUserMetricValue(e,t){switch(t){case"pageViews":return e.pageViews;case"sessionDuration":return e.sessionDuration;case"clicks":return e.clicks;default:return 0}}initDashboard(){this.modules.dashboard={create:e=>this.createDashboard(e)}}createDashboard(e){const t=document.getElementById(e);return t?(t.innerHTML=`\n      <div class="standlog-dashboard">\n        <h2>StandLog Analytics Dashboard</h2>\n        <div class="metrics">\n          <div class="metric">\n            <h3>Page Views</h3>\n            <span id="pageViews">${this.sessionData.pageViews}</span>\n          </div>\n          <div class="metric">\n            <h3>Clicks</h3>\n            <span id="clicks">${this.sessionData.clicks}</span>\n          </div>\n          <div class="metric">\n            <h3>Session Duration</h3>\n            <span id="duration">${Math.round((Date.now()-this.sessionData.startTime)/1e3)}s</span>\n          </div>\n        </div>\n        <div class="events">\n          <h3>Recent Events</h3>\n          <div id="eventsList"></div>\n        </div>\n      </div>\n    `,this.updateDashboard(t),t):null}updateDashboard(e){const t=e.querySelector("#eventsList");t&&(t.innerHTML=this.events.slice(-10).map((e=>`<div>${e.type} - ${new Date(e.timestamp).toLocaleTimeString()}</div>`)).join(""))}initIntegrations(){this.modules.integrations={exportData:e=>this.exportData(e),sendToSlack:(e,t)=>this.sendToSlack(e,t),sendToJira:(e,t)=>this.sendToJira(e,t)}}exportData(e="json"){const t={session:this.sessionData,events:this.events,timestamp:Date.now()};switch(e){case"json":return JSON.stringify(t,null,2);case"csv":return this.convertToCSV(t.events);default:throw new Error(`Format ${e} not supported`)}}convertToCSV(e){const t=[["timestamp","type","url"].join(",")];return e.forEach((e=>{t.push([e.timestamp,e.type,e.url||""].join(","))})),t.join("\n")}async sendToSlack(e,t){const s={text:"StandLog Analytics Update",attachments:[{title:"Session Data",fields:[{title:"Page Views",value:this.sessionData.pageViews,short:!0},{title:"Clicks",value:this.sessionData.clicks,short:!0}]}]};try{await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})}catch(e){console.error("Slack send failed:",e)}}addEvent(e){this.events.push(e),this.events.length>=10&&this.sendEvents()}async sendEvents(e=!1){if(0!==this.events.length)try{await this.ensureSession();const t={sessionId:this.sessionData.sessionId,events:this.events.map((e=>this.formatEventForAPI(e)))};await fetch("/events",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:e}),this.events=[],this.config.debug&&console.log("Events sent successfully")}catch(e){this.config.debug&&console.error("Failed to send events:",e)}}async ensureSession(){if(this.sessionCreated)return;const e={anonymousId:this.sessionData.anonymousId,metadata:{device:this.getDeviceInfo(),browser:this.getBrowser(navigator.userAgent),os:this.getOS(navigator.userAgent),language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screen:{width:screen.width,height:screen.height},viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,referrer:document.referrer,initialUrl:window.location.href,initialTitle:document.title}};try{const t=await fetch("/session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.ok){const e=await t.json();e.id&&(this.sessionData.sessionId=e.id,localStorage.setItem("standlog_session",e.id)),this.sessionCreated=!0,this.config.debug&&console.log("Session created:",e)}}catch(e){this.config.debug&&console.error("Failed to create session:",e)}}formatEventForAPI(e){return{type:e.type,metadata:{url:e.url||window.location.href,title:e.title||document.title,timestamp:e.timestamp,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},page:e.page||{url:window.location.href,title:document.title,referrer:document.referrer}},data:this.extractEventData(e)}}extractEventData(e){const t={sessionId:e.sessionId,userId:e.userId,timestamp:e.timestamp};switch(e.type){case"click":return{...t,coordinates:e.coordinates,element:e.element,viewport:e.viewport};case"scroll":return{...t,scroll:e.scroll,viewport:e.viewport};case"pageview":return{...t,page:e.page,device:e.device,viewport:e.viewport};case"form_submit":return{...t,form:e.form,page:e.page};case"custom":return{...t,name:e.name,properties:e.properties,page:e.page};case"visibility_change":return{...t,visible:e.visible,page:e.page};default:return t}}getOS(e){return e.includes("Windows")?"Windows":e.includes("Mac")?"macOS":e.includes("Linux")?"Linux":e.includes("Android")?"Android":e.includes("iOS")?"iOS":"Unknown"}getElementInfo(e){return{tagName:e.tagName?.toLowerCase(),id:e.id,className:e.className,textContent:e.textContent?.trim().substring(0,100)}}getDeviceInfo(){const e=navigator.userAgent;return{type:/Mobile|Android|iPhone|iPad/.test(e)?"mobile":"desktop",browser:this.getBrowser(e),language:navigator.language,viewport:{width:window.innerWidth,height:window.innerHeight}}}getBrowser(e){return e.includes("Chrome")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")?"Safari":e.includes("Edge")?"Edge":"Other"}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getAnonymousId(){let e=sessionStorage.getItem("standlog_anonymous");return e||(e=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,sessionStorage.setItem("standlog_anonymous",e)),e}getUserId(){let e=localStorage.getItem("standlog_user");return e||(e=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("standlog_user",e)),e}track(e,t={}){const s={type:"custom",name:e,properties:t,timestamp:Date.now(),url:window.location.href,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId};this.addEvent(s)}createHeatmap(e,t="click"){return this.modules.heatmaps?.createHeatmap(e,t)}defineFunnel(e,t,s={}){return this.modules.funnels?.defineFunnel(e,t,s)}createDashboard(e){return this.modules.dashboard?.create(e)}exportData(e="json"){return this.modules.integrations?.exportData(e)}getAnalytics(){return{session:this.sessionData,events:this.events,modules:Object.keys(this.modules)}}}window.StandLog={init:(e,t={})=>{if(!e){const t=document.querySelector("[data-standlog-id]");t&&(e=t.getAttribute("data-standlog-id"))}if(!e)return console.error("StandLog: API key required"),null;const s=new StandLogAnalytics(e,t);return window.standlog=s,s}},document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("[data-standlog-id]");if(e){const t=e.getAttribute("data-standlog-id"),s={};e.hasAttribute("data-debug")&&(s.debug="true"===e.getAttribute("data-debug")),e.hasAttribute("data-enable-heatmaps")&&(s.enableHeatmaps="true"===e.getAttribute("data-enable-heatmaps")),e.hasAttribute("data-enable-funnels")&&(s.enableFunnels="true"===e.getAttribute("data-enable-funnels")),e.hasAttribute("data-enable-personas")&&(s.enablePersonas="true"===e.getAttribute("data-enable-personas")),e.hasAttribute("data-enable-dashboard")&&(s.enableDashboard="true"===e.getAttribute("data-enable-dashboard")),e.hasAttribute("data-enable-integrations")&&(s.enableIntegrations="true"===e.getAttribute("data-enable-integrations")),window.StandLog.init(t,s)}}));const style=document.createElement("style");style.innerHTML="\n  .standlog-dashboard {\n    font-family: Arial, sans-serif;\n    max-width: 1200px;\n    margin: 20px auto;\n    padding: 20px;\n    background: #f9f9f9;\n    border-radius: 8px;\n  }\n  \n  .standlog-dashboard h2 {\n    color: #333;\n    margin-bottom: 20px;\n  }\n  \n  .metrics {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: 20px;\n    margin-bottom: 30px;\n  }\n  \n  .metric {\n    background: white;\n    padding: 20px;\n    border-radius: 6px;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    text-align: center;\n  }\n  \n  .metric h3 {\n    margin: 0 0 10px 0;\n    color: #666;\n    font-size: 14px;\n    text-transform: uppercase;\n  }\n  \n  .metric span {\n    font-size: 2em;\n    font-weight: bold;\n    color: #2196F3;\n  }\n  \n  .events {\n    background: white;\n    padding: 20px;\n    border-radius: 6px;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n  }\n  \n  .events h3 {\n    margin: 0 0 15px 0;\n    color: #333;\n  }\n  \n  #eventsList div {\n    padding: 8px 0;\n    border-bottom: 1px solid #eee;\n    font-size: 14px;\n    color: #666;\n  }\n",document.head.appendChild(style);