class PersonaAnalyzer{constructor(e={}){this.config={personas:[],autoSegment:!0,updateInterval:3e5,...e},this.users=new Map,this.segments=new Map,this.rules=new Map,this.initializeDefaultPersonas(),this.config.autoSegment&&this.startAutoSegmentation()}initializeDefaultPersonas(){this.definePersona("power_user",{name:"Power User",description:"Highly engaged users with frequent interactions",rules:[{metric:"pageViews",operator:">",value:10,timeframe:"session"},{metric:"sessionDuration",operator:">",value:3e5,timeframe:"session"},{metric:"clickCount",operator:">",value:50,timeframe:"session"}],color:"#4CAF50"}),this.definePersona("casual_user",{name:"Casual User",description:"Regular users with moderate engagement",rules:[{metric:"pageViews",operator:"between",value:[3,10],timeframe:"session"},{metric:"sessionDuration",operator:"between",value:[6e4,3e5],timeframe:"session"}],color:"#2196F3"}),this.definePersona("bouncer",{name:"Bouncer",description:"Users who leave quickly with minimal interaction",rules:[{metric:"pageViews",operator:"<=",value:1,timeframe:"session"},{metric:"sessionDuration",operator:"<",value:3e4,timeframe:"session"}],color:"#F44336"}),this.definePersona("mobile_user",{name:"Mobile User",description:"Users primarily accessing via mobile devices",rules:[{metric:"deviceType",operator:"=",value:"mobile",timeframe:"session"},{metric:"mobileSessionRatio",operator:">",value:.8,timeframe:"week"}],color:"#FF9800"}),this.definePersona("converter",{name:"Converter",description:"Users who complete conversion actions",rules:[{metric:"conversionEvents",operator:">",value:0,timeframe:"session"},{metric:"funnelCompletion",operator:"=",value:!0,timeframe:"session"}],color:"#9C27B0"})}definePersona(e,s){const t={id:e,name:s.name,description:s.description,rules:s.rules||[],color:s.color||"#757575",icon:s.icon,created:Date.now(),...s};return this.config.personas.push(t),this.segments.set(e,{persona:t,users:new Set,metrics:this.initializePersonaMetrics()}),t}initializePersonaMetrics(){return{totalUsers:0,activeUsers:0,avgSessionDuration:0,avgPageViews:0,conversionRate:0,retentionRate:0,topPages:[],commonDevices:[],timeDistribution:{},geographicDistribution:{}}}addUserEvent(e,s){this.users.has(e)||this.users.set(e,this.createUserProfile(e));const t=this.users.get(e);this.updateUserProfile(t,s),this.analyzeUserPersona(t)}createUserProfile(e){return{id:e,firstSeen:Date.now(),lastSeen:Date.now(),sessions:[],currentSession:null,personas:[],metrics:{totalSessions:0,totalPageViews:0,totalDuration:0,totalClicks:0,conversionEvents:0,deviceTypes:{},browsers:{},locations:{},referrers:{},pages:{}},attributes:{}}}updateUserProfile(e,s){e.lastSeen=s.timestamp,e.currentSession&&!this.isNewSession(e.currentSession,s)||this.startNewSession(e,s);const t=e.currentSession;switch(t.events.push(s),t.lastActivity=s.timestamp,s.type){case"pageview":e.metrics.totalPageViews++,t.pageViews++,this.updatePageMetrics(e,s);break;case"click":e.metrics.totalClicks++,t.clicks++;break;case"custom":s.name&&s.name.includes("conversion")&&(e.metrics.conversionEvents++,t.conversions++);break;case"form_submit":t.formSubmissions++}s.device&&this.updateDeviceMetrics(e,s.device),t.duration=t.lastActivity-t.startTime,e.metrics.totalDuration=e.sessions.reduce(((e,s)=>e+s.duration),0)}isNewSession(e,s){return s.timestamp-e.lastActivity>18e5}startNewSession(e,s){e.currentSession&&e.sessions.push(e.currentSession),e.currentSession={id:`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,startTime:s.timestamp,lastActivity:s.timestamp,duration:0,pageViews:0,clicks:0,conversions:0,formSubmissions:0,events:[],entryPage:s.page?.url||s.url,device:s.device,referrer:s.page?.referrer},e.metrics.totalSessions++}updatePageMetrics(e,s){const t=s.page?.url||s.url;t&&(e.metrics.pages[t]=(e.metrics.pages[t]||0)+1);const r=s.page?.referrer;r&&(e.metrics.referrers[r]=(e.metrics.referrers[r]||0)+1)}updateDeviceMetrics(e,s){const t=this.getDeviceType(s.userAgent);e.metrics.deviceTypes[t]=(e.metrics.deviceTypes[t]||0)+1;const r=this.getBrowser(s.userAgent);e.metrics.browsers[r]=(e.metrics.browsers[r]||0)+1}analyzeUserPersona(e){const s=new Set(e.personas.map((e=>e.id))),t=new Set;this.config.personas.forEach((r=>{this.userMatchesPersona(e,r)&&(t.add(r.id),s.has(r.id)||(e.personas.push({id:r.id,assignedAt:Date.now(),confidence:this.calculatePersonaConfidence(e,r)}),this.segments.get(r.id).users.add(e.id)))})),e.personas=e.personas.filter((s=>!!t.has(s.id)||(this.segments.get(s.id).users.delete(e.id),!1))),this.updatePersonaMetrics()}userMatchesPersona(e,s){return s.rules.every((s=>this.evaluateRule(e,s)))}evaluateRule(e,s){const t=this.getUserMetric(e,s.metric,s.timeframe);switch(s.operator){case">":return t>s.value;case"<":return t<s.value;case">=":return t>=s.value;case"<=":return t<=s.value;case"=":return t===s.value;case"!=":return t!==s.value;case"between":return t>=s.value[0]&&t<=s.value[1];case"in":return s.value.includes(t);default:return!1}}getUserMetric(e,s,t="all"){const r=e.currentSession;switch(s){case"pageViews":return"session"===t?r?.pageViews||0:e.metrics.totalPageViews;case"sessionDuration":return"session"===t?r?.duration||0:e.metrics.totalDuration/e.metrics.totalSessions;case"clickCount":return"session"===t?r?.clicks||0:e.metrics.totalClicks;case"conversionEvents":return"session"===t?r?.conversions||0:e.metrics.conversionEvents;case"deviceType":return this.getMostFrequentDevice(e);case"mobileSessionRatio":return this.getMobileSessionRatio(e,t);case"funnelCompletion":return r?.conversions>0;default:return 0}}calculatePersonaConfidence(e,s){let t=0,r=s.rules.length;return s.rules.forEach((s=>{const r=this.getUserMetric(e,s.metric,s.timeframe),i=s.value;let n=0;">"===s.operator&&r>i?n=Math.min(1,r/(2*i)):"="===s.operator&&r===i&&(n=1),t+=n})),Math.round(t/r*100)}getMostFrequentDevice(e){const s=e.metrics.deviceTypes;let t=0,r="desktop";return Object.entries(s).forEach((([e,s])=>{s>t&&(t=s,r=e)})),r}getMobileSessionRatio(e,s){const t=e.metrics.deviceTypes.mobile||0,r=e.metrics.totalSessions;return r>0?t/r:0}getDeviceType(e){return/Mobile|Android|iPhone|iPad/.test(e)?"mobile":/Tablet/.test(e)?"tablet":"desktop"}getBrowser(e){return e.includes("Chrome")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")?"Safari":e.includes("Edge")?"Edge":"Other"}updatePersonaMetrics(){this.segments.forEach(((e,s)=>{const t=Array.from(e.users).map((e=>this.users.get(e))).filter(Boolean),r=e.metrics;r.totalUsers=t.length,r.activeUsers=t.filter((e=>Date.now()-e.lastSeen<864e5)).length,t.length>0&&(r.avgSessionDuration=t.reduce(((e,s)=>e+s.metrics.totalDuration/s.metrics.totalSessions),0)/t.length,r.avgPageViews=t.reduce(((e,s)=>e+s.metrics.totalPageViews/s.metrics.totalSessions),0)/t.length,r.conversionRate=t.filter((e=>e.metrics.conversionEvents>0)).length/t.length)}))}getPersonaAnalysis(e){const s=this.segments.get(e);if(!s)return null;const t=Array.from(s.users).map((e=>this.users.get(e))).filter(Boolean);return{persona:s.persona,metrics:s.metrics,users:t.map((s=>({id:s.id,firstSeen:s.firstSeen,lastSeen:s.lastSeen,totalSessions:s.metrics.totalSessions,confidence:s.personas.find((s=>s.id===e))?.confidence||0}))),insights:this.generatePersonaInsights(s,t)}}generatePersonaInsights(e,s){const t=[],r=e.metrics;if(r.conversionRate>.1&&t.push(`High conversion rate: ${(100*r.conversionRate).toFixed(1)}%`),r.avgSessionDuration>3e5&&t.push("Users in this segment have long session durations"),r.totalUsers>0){r.activeUsers/r.totalUsers>.5&&t.push("High user engagement and activity")}return t}getAllPersonasAnalysis(){const e={};return this.segments.forEach(((s,t)=>{e[t]=this.getPersonaAnalysis(t)})),e}startAutoSegmentation(){setInterval((()=>{this.updatePersonaMetrics()}),this.config.updateInterval)}exportPersonaData(e="json"){const s=this.getAllPersonasAnalysis();return"csv"===e?this.convertPersonaToCSV(s):JSON.stringify(s,null,2)}convertPersonaToCSV(e){const s=[["Persona","Total Users","Active Users","Avg Session Duration","Conversion Rate"].join(",")];return Object.values(e).forEach((e=>{e&&s.push([e.persona.name,e.metrics.totalUsers,e.metrics.activeUsers,Math.round(e.metrics.avgSessionDuration/1e3),`${(100*e.metrics.conversionRate).toFixed(1)}%`].join(","))})),s.join("\n")}}"undefined"!=typeof module&&module.exports?module.exports=PersonaAnalyzer:window.PersonaAnalyzer=PersonaAnalyzer;